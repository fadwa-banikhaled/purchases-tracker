<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</title>
    <style>
      /* Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ */
      body {
          font-family: 'Arial', sans-serif;
          direction: rtl;
          padding: 20px;
          background-color: #f7f7f7;
      }
  
      h1 {
          color: #333;
          text-align: center;
      }
  
      input, button, select {
          padding: 10px;
          margin: 5px;
          font-size: 16px;
      }
  
      table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          background-color: #fff;
          overflow-x: auto;
      }
  
      th, td {
          border: 1px solid #ccc;
          padding: 12px;
          text-align: center;
          font-size: 16px;
      }
  
      .actions button {
          margin: 0 3px;
          padding: 6px 12px;
          font-size: 14px;
      }
  
      #selectedList {
          overflow-x: auto;
      }
  
      /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„ */
      @media (max-width: 768px) {
          input, button, select {
              width: 100%;
              margin: 8px 0;
          }
  
          table, thead, tbody, th, td, tr {
              display: block;
          }
  
          thead tr {
              display: none;
          }
  
          td {
              border: none;
              position: relative;
              padding-left: 50%;
              text-align: right;
          }
  
          td::before {
              position: absolute;
              top: 10px;
              right: 10px;
              white-space: nowrap;
              font-weight: bold;
              color: #555;
          }
  
          td:nth-child(1)::before { content: "ØªØ­Ø¯ÙŠØ¯"; }
          td:nth-child(2)::before { content: "#"; }
          td:nth-child(3)::before { content: "Ø§Ù„Ù…Ù†ØªØ¬"; }
          td:nth-child(4)::before { content: "Ø§Ù„Ø³Ø¹Ø±"; }
          td:nth-child(5)::before { content: "Ø§Ù„Ù…ÙƒØ§Ù†"; }
          td:nth-child(6)::before { content: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"; }
      }
  </style>
  
</head>
<body>
    <h1>Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</h1>

    <input type="text" id="product" placeholder="Ø§Ù„Ù…Ù†ØªØ¬" />
    <input type="number" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" />
    <input type="text" id="store" placeholder="Ø§Ù„Ù…ÙƒØ§Ù†" />
    <button onclick="addProduct()">Ø¥Ø¶Ø§ÙØ©</button>

    <br>
    <input type="text" id="search" placeholder="Ø¨Ø­Ø«..." oninput="renderTable()" />

    <button onclick="showSelectedList()">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>

<div id="selectedList" style="margin-top: 20px; background: #fff; padding: 10px; display:none;">
  <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
  <ul id="selectedItems"></ul>
  <p><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</strong> <span id="totalPrice">0</span> Ø±ÙŠØ§Ù„</p>
</div>

<button onclick="downloadAsExcel()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù </button>

    <table>
        <thead>
            <tr>
                <th>ØªØ­Ø¯ÙŠØ¯</th>
                <th>#</th>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwGVUgYwOoeYnYbCS5dIkrbIOcXPqNIxQIou3dEVJLK7k1p2-vDDgTcy3Oiirod0mQeNg/exec";

    let data = [];

    async function fetchData() {
      const res = await fetch(`${API_URL}?action=get`);
      const result = await res.json();
      data = result.slice(1); // Ø¨Ø¯ÙˆÙ† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      renderTable();
    }

    function renderTable() {
      const keyword = document.getElementById('search').value.toLowerCase();
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      data.forEach((row, index) => {
        if (row.join(" ").toLowerCase().includes(keyword)) {
          const tr = document.createElement("tr");
          let checked = ""; // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ÙÙŠ Ù…ØµÙÙˆÙØ© Ø¥Ù† Ù„Ø²Ù…
           tr.innerHTML = `
             <td><input type="checkbox" class="select-product" data-index="${index}"></td>
             <td>${index + 2}</td>
             <td><input value="${row[0]}" onchange="editRow(${index + 2}, 1, this.value)"></td>
             <td><input value="${row[1]}" onchange="editRow(${index + 2}, 2, this.value)"></td>
             <td><input value="${row[2]}" onchange="editRow(${index + 2}, 3, this.value)"></td>
             <td class="actions">
              <button onclick="deleteRow(${index + 2})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <button onclick="editProduct(${index + 2})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
             </td>
`;

          tbody.appendChild(tr);
        }
      });
    }

    async function addProduct() {
      const product = document.getElementById("product").value;
      const price = document.getElementById("price").value;
      const store = document.getElementById("store").value;
      if (!product || !price || !store) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

      await fetch(`${API_URL}?action=add&product=${encodeURIComponent(product)}&price=${price}&store=${encodeURIComponent(store)}`);
      document.getElementById("product").value = "";
      document.getElementById("price").value = "";
      document.getElementById("store").value = "";
      fetchData();
    }

    async function deleteRow(row) {
      await fetch(`${API_URL}?action=delete&row=${row}`);
      fetchData();
    }

    async function editProduct(row) {
  const rowData = data[row - 2];
  if (!rowData) return;

  // Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const newProduct = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬:", rowData[0]);
  const newPrice = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±:", rowData[1]);
  const newStore = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†:", rowData[2]);

  if (newProduct !== null && newPrice !== null && newStore !== null) {
    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± API Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch
    await fetch(`${API_URL}?action=edit&row=${row}&product=${encodeURIComponent(newProduct)}&price=${newPrice}&store=${encodeURIComponent(newStore)}`);
    fetchData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  }
}


    function showSelectedList() {
  const selectedList = document.getElementById("selectedList");
  const selectedItems = document.getElementById("selectedItems");
  const totalPrice = document.getElementById("totalPrice");

  selectedItems.innerHTML = ""; // Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ÙˆØ¶Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§
  let table = `<table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                  <thead>
                    <tr>
                      <th style="border: 1px solid #ccc; padding: 10px;">Ø§Ù„Ù…Ù†ØªØ¬</th>
                      <th style="border: 1px solid #ccc; padding: 10px;">Ø§Ù„Ø³Ø¹Ø±</th>
                      <th style="border: 1px solid #ccc; padding: 10px;">Ø§Ù„Ù…ÙƒØ§Ù†</th>
                    </tr>
                  </thead>
                  <tbody>`;

  let total = 0;
  const checkboxes = document.querySelectorAll(".select-product:checked");

  checkboxes.forEach(cb => {
    const index = parseInt(cb.dataset.index);
    const row = data[index];
    const name = row[0];
    const price = parseFloat(row[1]) || 0;
    const store = row[2];

    total += price;

    table += `<tr>
                <td style="border: 1px solid #ccc; padding: 10px;">${name}</td>
                <td style="border: 1px solid #ccc; padding: 10px;">${price} Ø±ÙŠØ§Ù„</td>
                <td style="border: 1px solid #ccc; padding: 10px;">${store}</td>
              </tr>`;
  });

  table += `</tbody></table>`;

  selectedItems.innerHTML = table;
  totalPrice.textContent = total;

  selectedList.style.display = "block";
}




function downloadAsExcel() {
  const checkboxes = document.querySelectorAll(".select-product:checked");
  if (checkboxes.length === 0) {
    alert("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù†ØªØ¬.");
    return;
  }

  let csvContent = "Ø§Ù„Ù…Ù†ØªØ¬,Ø§Ù„Ø³Ø¹Ø±,Ø§Ù„Ù…ÙƒØ§Ù†\n";
  let total = 0;

  checkboxes.forEach(cb => {
    const index = parseInt(cb.dataset.index);
    const row = data[index];
    const name = row[0];
    const price = parseFloat(row[1]) || 0;
    const store = row[2];

    total += price;

    csvContent += `"${name}","${price}","${store}"\n`;
  });

  // Ù†Ø¶ÙŠÙ Ø³Ø·Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
  csvContent += `"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±","${total}","Ø±ÙŠØ§Ù„"\n`;

  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª.csv";
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}




    fetchData();
    </script>
</body>
</html>
